{
  "version": 3,
  "sources": ["../../../../../../Users/alexcapsunel/Documents/GitHub/capsuna_work/netlify/functions/health.js", "../../../../../../Users/alexcapsunel/Documents/GitHub/capsuna_work/netlify/functions/utils/db.js"],
  "sourceRoot": "/var/folders/d6/2tbmdwln2p15fyp3qmqj0dt80000gn/T/tmp-18744-mahura5wax1a",
  "sourcesContent": ["import connectToDatabase from './utils/db.js';\n\nexport const handler = async (event, context) => {\n  // Make the database connection available for reuse\n  context.callbackWaitsForEmptyEventLoop = false;\n  \n  try {\n    // Try to connect to the database\n    console.log('Health check: Testing database connection');\n    const connection = await connectToDatabase();\n    const connectionState = connection.connection.readyState;\n    \n    // MongoDB readyState: 0 = disconnected, 1 = connected, 2 = connecting, 3 = disconnecting\n    const status = connectionState === 1 ? 'connected' : 'disconnected';\n    const dbName = connection.connection.db.databaseName;\n    \n    console.log(`Database connection status: ${status}, database name: ${dbName}`);\n    \n    // List collections to verify we have access\n    let collections = [];\n    try {\n      collections = await connection.connection.db.listCollections().toArray();\n      console.log('Available collections:', collections.map(c => c.name).join(', '));\n    } catch (err) {\n      console.error('Error listing collections:', err);\n    }\n    \n    return {\n      statusCode: 200,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        status: 'ok',\n        timestamp: new Date().toISOString(),\n        environment: process.env.NODE_ENV || 'development',\n        database: {\n          status,\n          connectionState,\n          databaseName: dbName,\n          collections: collections.map(c => c.name)\n        }\n      })\n    };\n  } catch (error) {\n    console.error('Health check error:', error);\n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        status: 'error',\n        message: 'Failed to connect to database',\n        error: error.message,\n        stack: error.stack\n      })\n    };\n  }\n}; ", "import mongoose from 'mongoose';\n\nlet cachedDb = null;\n\nasync function connectToDatabase() {\n  if (cachedDb) {\n    return cachedDb;\n  }\n\n  // Debug: Log all env vars starting with REACT_APP or MONGODB (without values for security)\n  console.log('Available env vars:', Object.keys(process.env).filter(k => \n    k.includes('MONGO') || k.includes('REACT_APP')\n  ));\n  \n  // Get MongoDB URI from environment\n  const mongoUri = process.env.REACT_APP_MONGODB_URI;\n  \n  // Debug logging\n  console.log('REACT_APP_MONGODB_URI exists:', !!mongoUri);\n  console.log('REACT_APP_MONGODB_URI type:', typeof mongoUri);\n  console.log('REACT_APP_MONGODB_URI length:', mongoUri ? mongoUri.length : 0);\n  \n  // Validate URI exists and is a non-empty string\n  if (!mongoUri || typeof mongoUri !== 'string' || mongoUri.trim() === '') {\n    const error = new Error(\n      'REACT_APP_MONGODB_URI environment variable is not set or is empty. ' +\n      'Please configure it in your Netlify dashboard under Site settings > Environment variables. ' +\n      `Current value type: ${typeof mongoUri}, truthy: ${!!mongoUri}`\n    );\n    console.error(error.message);\n    throw error;\n  }\n\n  // Validate URI format\n  if (!mongoUri.startsWith('mongodb://') && !mongoUri.startsWith('mongodb+srv://')) {\n    const error = new Error(\n      `Invalid MongoDB URI format. URI must start with 'mongodb://' or 'mongodb+srv://'. ` +\n      `Got: ${mongoUri.substring(0, 20)}...`\n    );\n    console.error(error.message);\n    throw error;\n  }\n\n  // Connection options\n  const options = {\n    dbName: 'capsuna_work' // Explicitly set the database name\n  };\n\n  try {\n    console.log('Connecting to MongoDB...');\n    console.log('MongoDB URI (masked):', mongoUri.replace(/\\/\\/([^:]+):([^@]+)@/, '//$1:****@'));\n    \n    const conn = await mongoose.connect(mongoUri, options);\n    cachedDb = conn;\n    console.log('MongoDB connected successfully to database:', conn.connection.db.databaseName);\n    return cachedDb;\n  } catch (error) {\n    console.error('MongoDB connection error:', error.message);\n    throw error;\n  }\n}\n\nexport default connectToDatabase; "],
  "mappings": "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",
  "names": ["mongoose"]
}
